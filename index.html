<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <title>Our Love Map üìç Mapping Every Date & Memory Together</title>
    <meta name="description" content="‰∏çÊÉ≥ÂøòË®òÂíå‰Ω†‰∏ÄËµ∑Â∫¶ÈÅéÁöÑ‰ªª‰Ωï‰∏ÄÂÄãÂçàÂæå„ÄÇÈÄôÊòØ‰∏ÄÂÄãÂè™Â±¨ÊñºÊàëÂÄëÂÖ©‰∫∫ÁöÑÂú∞ÂúñÔºåÁ¥ÄÈåÑÈÇ£‰∫õ‰∏ÄËµ∑Êï£Ê≠•„ÄÅ‰∏ÄËµ∑ÂêÉÈ£Ø„ÄÅ‰∏ÄËµ∑ÁôºÂëÜÁöÑÂ∞èÊó•Â≠ê„ÄÇÊàëÂÄëÁöÑÊïÖ‰∫ãÔºåÊú™ÂÆåÂæÖÁ∫å„ÄÇ">
    
    <meta property="og:title" content="Our Love Map üìç Mapping Every Date & Memory Together" />
    <meta property="og:image" content="https://a6300008.github.io/loveStory/fbshare.png" />
    
    <link rel="apple-touch-icon" sizes="180x180" href="https://a6300008.github.io/loveStory/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="https://a6300008.github.io/loveStory/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://a6300008.github.io/loveStory/favicon-16x16.png">
    <link rel="manifest" href="https://a6300008.github.io/loveStory/site.webmanifest">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=Varela+Round&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        themeMain: '#38bdf8',  
                        themePink: '#f43f5e',
                    },
                    fontFamily: {
                        sans: ['"Noto Sans TC"', 'sans-serif'],
                        cute: ['"Varela Round"', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <style>
        body { background-color: #f0f9ff; height: 100vh; width: 100vw; overflow: hidden; display: flex; flex-direction: column; }
        
        #map { position: absolute; top: 0; left: 0; right: 0; bottom: 0; z-index: 0; width: 100%; height: 100%; background: #e5e5e5; }
        
        .heart-marker {
            color: #f43f5e; font-size: 38px;
            filter: drop-shadow(0 4px 6px rgba(0,0,0,0.3));
            transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .heart-marker:hover { transform: scale(1.3) translateY(-5px); }
        .heart-icon-div {
            width: 38px !important; height: 38px !important;
            display: flex !important; align-items: center; justify-content: center;
            background: transparent; border: none;
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .search-scroll::-webkit-scrollbar { width: 4px; }
        .search-scroll::-webkit-scrollbar-track { background: #f1f5f9; }
        .search-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }

        #loading-overlay { position: fixed; inset: 0; background: rgba(255,255,255,0.8); backdrop-filter: blur(5px); z-index: 9999; align-items: center; justify-content: center; }

        .leaflet-popup-content-wrapper { padding: 0; border-radius: 16px; box-shadow: 0 20px 40px -5px rgba(0,0,0,0.2); overflow: hidden; }
        .leaflet-popup-content { margin: 0 !important; width: 100% !important; }
        .leaflet-popup-content p { margin: 0 !important; }
        .leaflet-container a.leaflet-popup-close-button { top: 12px; right: 12px; color: #94a3b8; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; background: #f1f5f9; border-radius: 50%; z-index: 20; }

        /* --- ÈüøÊáâÂºè‰ΩàÂ±ÄÈÇèËºØ --- */
        
        /* ÊâãÊ©üÁâàÔºöÊá∏ÊµÆÂàóË°® */
        .mobile-sheet {
            position: absolute;
            /* ‰øÆÊîπ 1: È´òÂ∫¶ÊèêÂçáËá≥ 280px */
            height: 280px; 
            left: 20px; right: 20px; bottom: 20px;
            background: rgba(255, 255, 255, 0.45);
            backdrop-filter: none;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
            z-index: 20;
            display: flex; flex-direction: column;
            transition: height 0.3s ease;
        }

        /* ÊéßÂà∂Âô® (Bottom Pill) - Á≤æÁ∑ªÂåñ */
        #mobile-controls {
            position: absolute; 
            /* ‰øÆÊîπÔºö‰ΩçÁΩÆ = bottom 20px + sheet 280px + gap 20px = 320px */
            bottom: 320px;
            left: 50%; transform: translateX(-50%);
            z-index: 40; 
            display: flex; align-items: center; 
            /* ‰øÆÊîπ 2: Á∏ÆÂ∞èÈñìË∑ùËàáÂÖßË∑ù */
            gap: 8px; 
            padding: 6px 12px;
            
            background: rgba(255, 255, 255, 0.95); 
            backdrop-filter: blur(10px);
            border-radius: 999px; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            border: 1px solid rgba(200,200,200,0.4); 
            transition: all 0.3s ease-out;
            
            /* ‰øÆÊîπ 2: ÁßªÈô§ min-widthÔºåÊîπÁÇ∫ auto */
            width: auto;
            justify-content: center;
        }
        /* ÊéßÂà∂Âô®Èö±ËóèÁãÄÊÖã (Â±ïÈñã Sheet ÊôÇ) */
        #mobile-controls.hidden-fade {
            opacity: 0;
            pointer-events: none;
            transform: translateX(-50%) translateY(20px);
        }

        #mobile-controls button {
            /* ‰øÆÊîπ 2: ÊåâÈàïÁ∏ÆÂ∞èËá≥ 36px (w-9 h-9) */
            width: 36px; height: 36px; border-radius: 999px;
            display: flex; align-items: center; justify-content: center;
            color: #475569; 
            font-size: 16px; /* icon Á®çÂæÆÁ∏ÆÂ∞è */
            transition: all 0.2s; flex-shrink: 0;
        }
        #mobile-controls button:hover { 
            background-color: #f1f5f9; 
            color: #38bdf8;
        }
        #mobile-controls .divider { width: 1px; height: 20px; background: #e2e8f0; margin: 0; }
        
        /* ÊêúÂ∞ãÊ°ÜÊ®£Âºè */
        #custom-search-wrapper {
            max-width: 0; opacity: 0; overflow: hidden;
            transition: max-width 0.3s ease-out, opacity 0.2s ease-out;
            display: flex; align-items: center;
        }
        #custom-search-wrapper.expanded {
            /* ‰øÆÊîπÔºöÂ±ïÈñãÊôÇÂØ¨Â∫¶ */
            max-width: 200px;
            opacity: 1;
        }
        #custom-search-input {
            width: 100%; height: 36px; background: transparent; 
            color: #334155; 
            border: none; outline: none; padding: 0 8px 0 4px; font-size: 14px;
        }
        #custom-search-input::placeholder { color: #94a3b8; }

        /* ÊêúÂ∞ãÁµêÊûúÂàóË°® */
        #search-results {
            position: absolute; 
            bottom: 100%; left: 50%; transform: translateX(-50%); width: 280px; 
            margin-bottom: 12px;
            background: rgba(255, 255, 255, 0.98); 
            backdrop-filter: blur(10px);
            border-radius: 12px; border: 1px solid #e2e8f0;
            max-height: 250px; overflow-y: auto; display: none;
            padding: 4px 0; color: #334155;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            z-index: 50;
        }
        #search-results li {
            padding: 12px 16px; font-size: 14px; cursor: pointer; border-bottom: 1px solid #f1f5f9;
            line-height: 1.4;
        }
        #search-results li:last-child { border-bottom: none; }
        #search-results li:hover { background: #f0f9ff; color: #38bdf8; }

        .controls-group { display: flex; align-items: center; gap: 8px; overflow: hidden; max-width: 200px; transition: max-width 0.3s ease; }
        .controls-group.hidden-force { max-width: 0; opacity: 0; pointer-events: none; }

        /* Âç°ÁâáÊ®£Âºè */
        .cute-card {
            background: white;
            border: 1px solid #e2e8f0;
            transition: all 0.25s ease-out;
            position: relative; 
            overflow: hidden;
            border-radius: 0.75rem; 
        }
        .cute-card:hover { background-color: #f0f9ff; border-color: #bae6fd; z-index: 10; box-shadow: 0 4px 12px rgba(14, 165, 233, 0.1); }
        .cute-card::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 4px; background: #e2e8f0; transition: all 0.25s ease; }
        .cute-card:hover::before { width: 6px; background: #38bdf8; }

        @media (min-width: 768px) {
            .mobile-sheet {
                position: static; top: auto; bottom: auto; left: auto; right: auto;
                width: 25%; height: 100%; 
                background: white; 
                border-radius: 0; box-shadow: none; border-right: 1px solid #e2e8f0; z-index: 20;
                margin: 0; overflow: hidden;
            }
            .mobile-sheet > div:first-child { display: none; }
            #map-container { position: relative; width: 75%; height: 100%; }
            #map { position: relative; }
            #mobile-controls { bottom: 24px; left: 50%; transform: translateX(-50%); }
        }
    </style>
</head>
<body class="text-slate-600 font-sans">

    <div id="loading-overlay" class="hidden flex">
        <div class="flex flex-col items-center">
            <i class="fa-solid fa-heart fa-beat text-5xl text-themePink mb-4"></i>
            <p class="text-slate-500 font-bold tracking-widest text-sm">LOADING MAP...</p>
        </div>
    </div>

    <!-- Â∞éËà™Âàó -->
    <nav class="absolute top-4 left-4 right-4 h-14 bg-white/90 backdrop-blur-md rounded-full shadow-lg z-30 flex items-center justify-between px-5 md:hidden">
        <div class="flex items-center gap-2">
            <i class="fa-solid fa-heart text-themePink text-xl"></i>
            <h1 class="text-lg font-bold text-slate-700 font-cute">Our Love Map</h1>
        </div>
        <div class="flex gap-2">
            <button onclick="fetchData()" class="w-8 h-8 rounded-full bg-slate-100 text-slate-500 flex items-center justify-center hover:bg-themeMain hover:text-white transition"><i class="fa-solid fa-rotate-right"></i></button>
            <a href="https://docs.google.com/spreadsheets/d/1DF-y3MZbru0_hcmwe0K0TwRW_H-s-LxhkNgKZkZiHkU/edit" target="_blank" class="w-8 h-8 rounded-full bg-green-50 text-green-600 flex items-center justify-center hover:bg-green-500 hover:text-white transition"><i class="fa-solid fa-table"></i></a>
        </div>
    </nav>

    <nav class="hidden md:flex bg-white border-b border-slate-200 h-16 items-center justify-between px-6 z-30 shadow-sm relative">
        <div class="flex items-center gap-2">
            <i class="fa-solid fa-heart text-themePink text-2xl"></i>
            <h1 class="text-xl font-bold text-slate-700 font-cute">Our Love Map <span class="text-sm font-normal text-slate-400 ml-2">üìç Mapping Every Date & Memory Together</span></h1>
        </div>
        <div class="flex gap-3">
            <button onclick="fetchData()" class="px-4 py-1.5 rounded-lg bg-slate-100 hover:bg-themeMain hover:text-white transition text-sm font-bold">ÂêåÊ≠•Ë≥áÊñô</button>
            <a href="https://docs.google.com/spreadsheets/d/1DF-y3MZbru0_hcmwe0K0TwRW_H-s-LxhkNgKZkZiHkU/edit" target="_blank" class="px-4 py-1.5 rounded-lg bg-green-50 text-green-600 hover:bg-green-500 hover:text-white transition text-sm font-bold">Google Sheet</a>
        </div>
    </nav>

    <div class="flex-1 flex flex-col md:flex-row h-full relative overflow-hidden">
        
        <aside class="mobile-sheet">
            <div class="w-full flex justify-center pt-3 pb-1 md:hidden" onclick="toggleSheet()">
                <div class="w-10 h-1.5 bg-slate-300 rounded-full"></div>
            </div>

            <div class="px-5 py-2 border-b border-slate-100/50 flex justify-between items-end">
                <div class="flex items-center gap-2">
                    <i class="fa-solid fa-images text-themeMain text-lg"></i>
                    <h2 class="font-bold text-slate-700 text-lg">ÂõûÊÜ∂Áõ∏Á∞ø</h2>
                </div>
                <span class="text-xs bg-themePink text-white px-3 py-1 rounded-full font-bold" id="count-display">0</span>
            </div>

            <div id="location-list" class="flex-1 overflow-y-auto no-scrollbar px-5 py-2 pb-24 md:block md:p-0 md:px-6 md:py-4 md:space-y-0 grid grid-cols-1 gap-4 md:gap-4"></div>
        </aside>

        <section id="map-container" class="w-full h-full relative">
            <div id="map"></div>
            
            <!-- Â∫ïÈÉ®ÊéßÂà∂Âô® -->
            <div id="mobile-controls" class="absolute z-[40]">
                
                <ul id="search-results" class="search-scroll"></ul>

                <button id="search-toggle-btn" onclick="toggleCustomSearch(event)" class="hover:bg-slate-100 transition active:scale-95">
                    <i class="fa-solid fa-magnifying-glass"></i>
                </button>

                <div id="custom-search-wrapper" class="flex-1 max-w-0 opacity-0 overflow-hidden transition-all duration-300">
                    <input type="text" id="custom-search-input" placeholder="ÊêúÂ∞ãÂú∞Èªû..." 
                           class="w-full h-full bg-transparent text-slate-700 placeholder-slate-400 border-none outline-none px-2 text-base">
                </div>

                <div id="controls-group" class="controls-group flex items-center">
                    <div class="divider"></div>
                    <button onclick="map.zoomOut()" class="hover:bg-slate-100 transition active:scale-95"><i class="fa-solid fa-minus"></i></button>
                    <button onclick="map.zoomIn()" class="hover:bg-slate-100 transition active:scale-95"><i class="fa-solid fa-plus"></i></button>
                    <div class="divider"></div>
                    <button onclick="fitAllMarkers()" class="hover:bg-themeMain hover:text-white transition active:scale-95"><i class="fa-solid fa-expand"></i></button>
                </div>
            </div>
        </section>

    </div>

    <!-- Modal -->
    <div id="data-modal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[2000] hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl shadow-2xl w-full max-w-sm overflow-hidden transform transition-all scale-100 relative animate-[fadeIn_0.2s_ease-out]">
            <button onclick="closeModal()" class="absolute top-4 right-4 w-8 h-8 flex items-center justify-center bg-slate-100 rounded-full text-slate-400 hover:bg-slate-200 transition"><i class="fa-solid fa-xmark"></i></button>
            <div class="p-6">
                <h3 class="font-bold text-xl text-slate-800 mb-5 flex items-center gap-2">
                    <div class="w-8 h-8 rounded-full bg-themePink/10 flex items-center justify-center text-themePink"><i class="fa-solid fa-pen-nib"></i></div>
                    <span id="modal-title">Write Memory</span>
                </h3>
                <form id="data-form" class="space-y-4">
                    <input type="hidden" id="entry-id"><input type="hidden" id="entry-lat"><input type="hidden" id="entry-lng">
                    <div>
                        <label class="block text-xs font-bold text-slate-400 mb-1 ml-1 uppercase">Location</label>
                        <input type="text" id="entry-name" required class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 text-slate-700 font-bold focus:ring-2 focus:ring-themeMain focus:border-transparent outline-none transition">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-400 mb-1 ml-1 uppercase">Date</label>
                        <input type="date" id="entry-date" required class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 text-slate-600 focus:ring-2 focus:ring-themeMain focus:border-transparent outline-none transition">
                    </div>
                    <div class="bg-slate-50 p-1 rounded-xl flex gap-1">
                        <button type="button" onclick="switchTab('boy')" id="tab-boy" class="tab-btn boy flex-1 py-2 text-sm text-slate-400 font-bold"><i class="fa-solid fa-mars mr-1"></i> Áî∑Âèã</button>
                        <button type="button" onclick="switchTab('girl')" id="tab-girl" class="tab-btn girl flex-1 py-2 text-sm text-slate-400 font-bold"><i class="fa-solid fa-venus mr-1"></i> Â•≥Âèã</button>
                    </div>
                    <div id="panel-boy" class="hidden">
                        <textarea id="entry-note-boy" rows="4" placeholder="ÂØ´‰∏ã‰Ω†ÁöÑÂøÉÊÉÖ..." class="w-full bg-blue-50/50 rounded-xl border border-blue-100 p-4 text-sm text-slate-700 outline-none focus:ring-2 focus:ring-blue-200 resize-none"></textarea>
                    </div>
                    <div id="panel-girl" class="hidden">
                        <textarea id="entry-note-girl" rows="4" placeholder="ÂØ´‰∏ãÂ¶≥ÁöÑÂøÉÊÉÖ..." class="w-full bg-pink-50/50 rounded-xl border border-pink-100 p-4 text-sm text-slate-700 outline-none focus:ring-2 focus:ring-pink-200 resize-none"></textarea>
                    </div>
                    <div class="pt-2 flex gap-3">
                        <button type="button" onclick="closeModal()" class="flex-1 py-3 text-sm font-bold text-slate-400 hover:text-slate-600 bg-slate-50 rounded-xl transition">ÂèñÊ∂à</button>
                        <button type="submit" class="flex-1 py-3 bg-themeMain text-white text-sm rounded-xl hover:bg-sky-500 shadow-lg shadow-sky-200 transform active:scale-95 transition font-bold tracking-wide">ÂÑ≤Â≠òÂõûÊÜ∂</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbzIBS75lONz_PPVYoO_M72HIo0M6le_9cuiUrKYxB8w9G13D8swdXqfv4tlZ69k28OX0A/exec"; 
        let map;
        let markers = [];
        let spots = [];
        let currentTab = 'boy';
        let currentSort = 'date';
        let isSheetExpanded = false;
        let searchTimeout; 
        let tempSearchMarker;

        // ‰øÆÊîπÔºö‰ΩøÁî® height ËÆäÂåñÔºåcontrols ‰ΩçÁΩÆ‰æùË≥¥ 280px È´òÂ∫¶
        function toggleSheet() {
            const sheet = document.querySelector('.mobile-sheet');
            const controls = document.getElementById('mobile-controls');
            
            // ÊâãÊ©üÁâàÈÇèËºØ (ÈõªËÖ¶Áâà‰∏çÂü∑Ë°å)
            if (window.innerWidth >= 768) return;

            if (sheet.style.height === '85%') { 
                // Êî∂Âõû -> È´òÂ∫¶ 280px
                sheet.style.height = '280px';
                controls.classList.remove('hidden-fade');
                controls.style.pointerEvents = 'auto'; 
                // ÊÅ¢Âæ©‰ΩçÁΩÆÔºö280 + 20(bottom) + 20(gap) = 320px
                controls.style.bottom = '320px';
            } else { 
                // Â±ïÈñã -> È´òÂ∫¶ 85%
                sheet.style.height = '85%';
                // Èö±Ëóè Controls (ÈÅøÂÖçÈÅÆÊìã Header)
                controls.classList.add('hidden-fade');
                controls.style.pointerEvents = 'none'; 
            }
            isSheetExpanded = !isSheetExpanded;
        }

        function toggleCustomSearch(e) {
            if (e) e.stopPropagation();
            const wrapper = document.getElementById('custom-search-wrapper');
            const input = document.getElementById('custom-search-input');
            const searchButton = document.getElementById('search-toggle-btn');
            const controlsGroup = document.getElementById('controls-group');
            const resultList = document.getElementById('search-results');

            if (wrapper.classList.contains('expanded')) {
                wrapper.classList.remove('expanded');
                controlsGroup.classList.remove('hidden-force'); 
                searchButton.innerHTML = '<i class="fa-solid fa-magnifying-glass"></i>';
                input.value = '';
                input.blur();
                resultList.style.display = 'none';
                if(tempSearchMarker) {
                    map.removeLayer(tempSearchMarker);
                    tempSearchMarker = null;
                }
            } else {
                wrapper.classList.add('expanded');
                controlsGroup.classList.add('hidden-force'); 
                searchButton.innerHTML = '<i class="fa-solid fa-xmark text-lg"></i>';
                input.focus();
            }
        }

        // ‰ΩøÁî® ArcGIS API ÊêúÂ∞ã (Âè∞ÁÅ£ÁØÑÂúçÂÑ™Âåñ)
        document.addEventListener('DOMContentLoaded', () => {
            const searchInput = document.getElementById('custom-search-input');
            const resultList = document.getElementById('search-results');

            searchInput.addEventListener('input', function(e) {
                const query = e.target.value;
                if(query.length < 2) {
                    resultList.style.display = 'none';
                    return;
                }

                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    const url = `https://geocode.arcgis.com/arcgis/rest/services/World/GeocodeServer/findAddressCandidates?singleLine=${encodeURIComponent(query)}&countryCode=TW&f=json&outSR=4326&maxLocations=5`;
                    
                    fetch(url)
                        .then(response => response.json())
                        .then(data => {
                            resultList.innerHTML = '';
                            if (data.candidates && data.candidates.length > 0) {
                                data.candidates.forEach(result => {
                                    const li = document.createElement('li');
                                    li.textContent = result.address;
                                    li.onclick = () => {
                                        const lat = result.location.y;
                                        const lon = result.location.x;
                                        
                                        flyToSpot(lat, lon);
                                        
                                        if(tempSearchMarker) map.removeLayer(tempSearchMarker);
                                        tempSearchMarker = L.marker([lat, lon]).addTo(map)
                                            .bindPopup(`<b>${result.address}</b><br>ÈªûÊìäÂú∞ÂúñÂÖ∂‰ªñËôïÂèØÊñ∞Â¢ûÂõûÊÜ∂`)
                                            .openPopup();
                                        
                                        toggleCustomSearch();
                                    };
                                    resultList.appendChild(li);
                                });
                                resultList.style.display = 'block';
                            } else {
                                resultList.style.display = 'none';
                            }
                        })
                        .catch(err => console.error("Search error:", err));
                }, 500); 
            });
        });

        function switchTab(gender) {
            currentTab = gender;
            const boyBtn = document.getElementById('tab-boy');
            const girlBtn = document.getElementById('tab-girl');
            const boyPanel = document.getElementById('panel-boy');
            const girlPanel = document.getElementById('panel-girl');
            if (gender === 'boy') {
                boyBtn.classList.add('active'); girlBtn.classList.remove('active');
                boyPanel.classList.remove('hidden'); girlPanel.classList.add('hidden');
            } else {
                boyBtn.classList.remove('active'); girlBtn.classList.add('active');
                boyPanel.classList.add('hidden'); girlPanel.classList.remove('hidden');
            }
        }

        function changeSort(mode) { currentSort = mode; renderAll(); }

        window.toggleBubble = function(e, div) {
            if(e) { e.stopPropagation(); e.preventDefault(); }
            const p = div.querySelector('p');
            p.classList.toggle('line-clamp-2');
            setTimeout(() => { map.eachLayer(l => { if(l instanceof L.Popup && l.isOpen()) l.update(); }); }, 10);
        };

        function flyToSpot(lat, lng, callback) {
            const targetZoom = 16;
            const mapHeight = map.getSize().y;
            map.closePopup();

            const isMobile = window.innerWidth < 768;
            const offsetRatio = isMobile ? 0.1 : 0; 

            const point = map.project([lat, lng], targetZoom);
            const targetPoint = L.point(point.x, point.y - (mapHeight * offsetRatio)); 
            const newCenter = map.unproject(targetPoint, targetZoom);
            
            const dist = map.distance(map.getCenter(), newCenter);
            if (dist < 50) { if (callback) callback(); return; }

            map.flyTo(newCenter, targetZoom, { animate: true, duration: 0.6 });
            map.once('moveend', function() { setTimeout(() => { if (callback) callback(); }, 150); });
        }

        function fitAllMarkers() {
            if (markers.length > 0) {
                const group = new L.featureGroup(markers);
                map.fitBounds(group.getBounds().pad(0.1));
            } else {
                map.setView([25.07, 121.51], 12);
            }
        }

        async function fetchData() {
            showLoading(true);
            try {
                const response = await fetch(`${API_URL}?action=read&t=${new Date().getTime()}`);
                if (!response.ok) throw new Error('Network error');
                spots = await response.json();
                renderAll();
            } catch (error) { alert("ËÆÄÂèñÂ§±ÊïóÔºö" + error.message); } 
            finally { showLoading(false); }
        }

        async function sendData(action, data) {
            showLoading(true);
            try {
                const response = await fetch(`${API_URL}?action=${action}`, {
                    method: 'POST', body: JSON.stringify(data), headers: { "Content-Type": "text/plain;charset=utf-8" }
                });
                const result = await response.json();
                if (result.status === "success") { await fetchData(); closeModal(); }
                else { throw new Error(result.message); }
            } catch (error) { alert("ÂÑ≤Â≠òÂ§±ÊïóÔºö" + error.message); }
            finally { showLoading(false); }
        }

        function initMap() {
            map = L.map('map', { zoomControl: false }).setView([25.07, 121.51], 12);
            map.invalidateSize(); 
            
            L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; CARTO', maxZoom: 20
            }).addTo(map);

            map.on('click', onMapClick);
            
            map.on('popupopen', function(e) {
                const popup = e.popup;
                setTimeout(() => { popup.update(); }, 10);
            });

            fetchData();

            const controls = document.getElementById('mobile-controls');
            if (window.innerWidth < 768) {
                controls.style.bottom = '320px'; // ‰øÆÊ≠£ÔºöÂàùÂßã‰ΩçÁΩÆ 320px
            } else {
                controls.style.bottom = '24px';
            }
        }

        function getHeartIcon() {
            return L.divIcon({ className: 'heart-icon-div', html: '<i class="fa-solid fa-heart heart-marker"></i>', iconSize: [38, 38], iconAnchor: [19, 36], popupAnchor: [0, -40] });
        }

        function renderAll() {
            markers.forEach(m => map.removeLayer(m));
            markers = [];
            const listContainer = document.getElementById('location-list');
            listContainer.innerHTML = '';
            document.getElementById('count-display').innerText = spots.length;

            if (spots.length === 0) listContainer.innerHTML = `<div class="p-10 text-center text-slate-300 col-span-1">Â∞öÁÑ°ÂõûÊÜ∂ÔºåÈªûÊìäÂú∞ÂúñÊñ∞Â¢ûÔºÅ</div>`;

            let sortedSpots = [...spots];
            sortedSpots.sort((a, b) => new Date(b.date) - new Date(a.date));

            sortedSpots.forEach(spot => {
                const popupContent = `
                    <div class="font-sans w-[280px] p-3 bg-white relative">
                        <div class="mb-2 border-b border-slate-100 pb-2 pr-24">
                            <h3 class="font-bold text-slate-800 text-lg leading-tight break-words">${spot.name}</h3>
                            <div class="flex items-center gap-1 text-[11px] text-slate-400 mt-0.5">
                                <i class="fa-regular fa-calendar"></i><span>${spot.date}</span>
                            </div>
                        </div>
                        
                        <div class="absolute top-2.5 right-10 flex gap-1">
                            <a href="https://www.google.com/maps/search/?api=1&query=${spot.lat},${spot.lng}" target="_blank" class="w-8 h-8 flex items-center justify-center rounded-full bg-slate-50 text-slate-400 hover:bg-emerald-50 hover:text-emerald-500 transition" title="Â∞éËà™"><i class="fa-solid fa-location-arrow text-sm"></i></a>
                            <button onclick="editSpot(${spot.id})" class="w-8 h-8 flex items-center justify-center rounded-full bg-slate-50 text-slate-400 hover:bg-themeMain hover:text-white transition" title="Á∑®ËºØ"><i class="fa-solid fa-pen text-sm"></i></button>
                        </div>

                        <div class="space-y-2 mb-1 max-h-[220px] overflow-y-auto custom-scroll pr-1">
                            <div class="flex gap-2 items-start">
                                <div class="w-6 h-6 rounded-full bg-blue-100 flex items-center justify-center text-blue-500 flex-none text-[10px]"><i class="fa-solid fa-mars"></i></div>
                                <div onclick="toggleBubble(event, this)" class="bg-blue-50 rounded-xl rounded-tl-none px-3 py-2 text-sm text-slate-600 flex-1 border border-blue-100/50 shadow-sm cursor-pointer hover:bg-blue-100/50 transition">
                                    <p class="break-words !m-0 whitespace-pre-line line-clamp-2 transition-all duration-300">${spot.note_boy || '...'}</p>
                                </div>
                            </div>
                            <div class="flex gap-2 items-start flex-row-reverse">
                                <div class="w-6 h-6 rounded-full bg-pink-100 flex items-center justify-center text-themePink flex-none text-[10px]"><i class="fa-solid fa-venus"></i></div>
                                <div class="bg-pink-50 rounded-xl rounded-tr-none px-3 py-2 text-sm text-slate-600 flex-1 border border-pink-100/50 shadow-sm text-right cursor-pointer hover:bg-pink-100/50 transition">
                                    <p class="break-words !m-0 text-left whitespace-pre-line line-clamp-2 transition-all duration-300">${spot.note_girl || '...'}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                const marker = L.marker([spot.lat, spot.lng], { icon: getHeartIcon() })
                    .addTo(map)
                    .bindPopup(popupContent, { maxWidth: 320, minWidth: 280, autoPan: false });
                
                marker.off('click');
                marker.on('click', function() { flyToSpot(spot.lat, spot.lng, () => { this.openPopup(); }); });
                markers.push(marker);

                const card = document.createElement('div');
                card.className = "cute-card p-4 cursor-pointer group hover:border-themeMain transition-all bg-white border border-slate-100 rounded-xl shadow-sm flex flex-col justify-between min-h-[165px] md:h-auto md:min-h-0";
                
                card.onclick = (e) => {
                    if(e.target.closest('button')) return;
                    if (window.innerWidth < 768 && isSheetExpanded) {
                        toggleSheet();
                    }
                    flyToSpot(spot.lat, spot.lng, () => { marker.openPopup(); });
                };

                card.innerHTML = `
                    <div class="flex justify-between items-start mb-3">
                        <div class="flex-1 w-full overflow-hidden">
                            <h3 class="font-bold text-slate-700 text-lg group-hover:text-themeMain transition truncate">${spot.name}</h3>
                            <div class="flex items-center gap-1 text-xs text-slate-400 mt-1"><i class="fa-regular fa-calendar"></i><span>${spot.date}</span></div>
                        </div>
                        <div class="flex gap-2 opacity-80">
                            <button onclick="editSpot(${spot.id})" class="text-slate-400 hover:text-themeMain"><i class="fa-solid fa-pen"></i></button>
                            <button onclick="deleteSpot(${spot.id})" class="text-slate-400 hover:text-themePink"><i class="fa-solid fa-trash-can"></i></button>
                        </div>
                    </div>
                    <div class="space-y-2">
                        <div class="flex items-center gap-2 text-sm text-slate-500 bg-slate-50 p-2 rounded-lg"><i class="fa-solid fa-mars text-blue-400"></i><p class="truncate flex-1">${spot.note_boy || '-'}</p></div>
                        <div class="flex items-center gap-2 text-sm text-slate-500 bg-slate-50 p-2 rounded-lg"><i class="fa-solid fa-venus text-themePink"></i><p class="truncate flex-1">${spot.note_girl || '-'}</p></div>
                    </div>
                `;
                listContainer.appendChild(card);
            });
        }

        function onMapClick(e) { openModal('add', { lat: e.latlng.lat, lng: e.latlng.lng }); }
        
        function openModal(mode, data = {}) {
            const modal = document.getElementById('data-modal');
            modal.classList.remove('hidden'); switchTab('boy');
            
            if (mode === 'add') {
                document.getElementById('modal-title').innerText = "New Memory";
                document.getElementById('data-form').reset();
                document.getElementById('entry-id').value = ''; 
                document.getElementById('entry-lat').value = data.lat;
                document.getElementById('entry-lng').value = data.lng;
                document.getElementById('entry-date').valueAsDate = new Date();
                setTimeout(() => document.getElementById('entry-name').focus(), 100);
            } else {
                document.getElementById('modal-title').innerText = "Edit Memory";
                document.getElementById('entry-id').value = data.id;
                document.getElementById('entry-name').value = data.name;
                document.getElementById('entry-date').value = data.date;
                document.getElementById('entry-lat').value = data.lat;
                document.getElementById('entry-lng').value = data.lng;
                document.getElementById('entry-note-boy').value = data.note_boy || '';
                document.getElementById('entry-note-girl').value = data.note_girl || '';
            }
        }
        function closeModal() { document.getElementById('data-modal').classList.add('hidden'); }
        window.editSpot = function(id) { const spot = spots.find(s => s.id == id); if (spot) openModal('edit', spot); };
        window.deleteSpot = function(id) { if(confirm('Á¢∫ÂÆöË¶ÅÂà™Èô§ÈÄôÁ≠ÜÂõûÊÜ∂ÂóéÔºü')) sendData('delete', { id: id }); };
        
        window.fitAllMarkers = function() {
            if (markers.length > 0) {
                const group = new L.featureGroup(markers);
                map.fitBounds(group.getBounds().pad(0.1));
            } else {
                map.setView([25.07, 121.51], 12);
            }
        }

        function showLoading(show) { document.getElementById('loading-overlay').style.display = show ? 'flex' : 'none'; }
        document.getElementById('data-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const id = document.getElementById('entry-id').value;
            const data = {
                id: id ? id : Date.now().toString(),
                name: document.getElementById('entry-name').value, date: document.getElementById('entry-date').value,
                lat: document.getElementById('entry-lat').value, lng: document.getElementById('entry-lng').value,
                note_boy: document.getElementById('entry-note-boy').value, note_girl: document.getElementById('entry-note-girl').value
            };
            sendData(id ? 'update' : 'create', data);
        });
        window.onload = initMap;
        window.addEventListener('resize', () => {
            if (map) {
                map.invalidateSize();
                const controls = document.getElementById('mobile-controls');
                if (window.innerWidth < 768) {
                    controls.style.bottom = '320px';
                } else {
                    controls.style.bottom = '24px';
                }
            }
        });
    </script>
</body>
</html>