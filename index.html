<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <title>Our Love Map üìç Mapping Every Date & Memory Together</title>
    <meta name="description" content="‰∏çÊÉ≥ÂøòË®òÂíå‰Ω†‰∏ÄËµ∑Â∫¶ÈÅéÁöÑ‰ªª‰Ωï‰∏ÄÂÄãÂçàÂæå„ÄÇÈÄôÊòØ‰∏ÄÂÄãÂè™Â±¨ÊñºÊàëÂÄëÂÖ©‰∫∫ÁöÑÂú∞ÂúñÔºåÁ¥ÄÈåÑÈÇ£‰∫õ‰∏ÄËµ∑Êï£Ê≠•„ÄÅ‰∏ÄËµ∑ÂêÉÈ£Ø„ÄÅ‰∏ÄËµ∑ÁôºÂëÜÁöÑÂ∞èÊó•Â≠ê„ÄÇÊàëÂÄëÁöÑÊïÖ‰∫ãÔºåÊú™ÂÆåÂæÖÁ∫å„ÄÇ">
    
    <meta property="og:title" content="Our Love Map üìç Mapping Every Date & Memory Together" />
    <meta property="og:description" content="‰∏çÊÉ≥ÂøòË®òÂíå‰Ω†‰∏ÄËµ∑Â∫¶ÈÅéÁöÑ‰ªª‰Ωï‰∏ÄÂÄãÂçàÂæå„ÄÇÈÄôÊòØ‰∏ÄÂÄãÂè™Â±¨ÊñºÊàëÂÄëÂÖ©‰∫∫ÁöÑÂú∞ÂúñÔºåÁ¥ÄÈåÑÈÇ£‰∫õ‰∏ÄËµ∑Êï£Ê≠•„ÄÅ‰∏ÄËµ∑ÂêÉÈ£Ø„ÄÅ‰∏ÄËµ∑ÁôºÂëÜÁöÑÂ∞èÊó•Â≠ê„ÄÇÊàëÂÄëÁöÑÊïÖ‰∫ãÔºåÊú™ÂÆåÂæÖÁ∫å„ÄÇ" />
    <meta property="og:image" content="https://a6300008.github.io/loveStory/fbshare.png" />
    
    <link rel="apple-touch-icon" sizes="180x180" href="https://a6300008.github.io/loveStory/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="https://a6300008.github.io/loveStory/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://a6300008.github.io/loveStory/favicon-16x16.png">
    <link rel="manifest" href="https://a6300008.github.io/loveStory/site.webmanifest">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&family=Varela+Round&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        themeLight: '#e0f2fe', 
                        themeMain: '#38bdf8',  
                        themeDark: '#0ea5e9',
                    },
                    fontFamily: {
                        sans: ['"Noto Sans TC"', 'sans-serif'],
                        cute: ['"Varela Round"', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <style>
        body { background-color: #f0f9ff; height: 100vh; display: flex; flex-direction: column; }
        #map { height: 100%; width: 100%; z-index: 1; border-radius: 0.5rem; border: 4px solid #fff; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
        
        .heart-marker {
            color: #f43f5e; font-size: 34px;
            filter: drop-shadow(0 3px 2px rgba(0,0,0,0.2));
            transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .heart-marker:hover { transform: scale(1.25); }
        
        .heart-icon-div {
            width: 34px !important; height: 34px !important;
            display: flex !important; align-items: center; justify-content: center;
            background: transparent; border: none;
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f5f9; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        #loading-overlay { position: fixed; inset: 0; background: rgba(255,255,255,0.9); z-index: 2000; align-items: center; justify-content: center; }
        
        .cute-card {
            background: white; border: 1px solid #e2e8f0;
            transition: all 0.25s ease-out; position: relative; overflow: hidden;
            border-radius: 0.5rem; margin-bottom: 0;
        }
        @media (min-width: 768px) { .cute-card { border-radius: 0; margin-bottom: -1px; } }

        .cute-card:hover { background-color: #f0f9ff; border-color: #bae6fd; z-index: 10; box-shadow: 0 4px 12px rgba(14, 165, 233, 0.1); }
        .cute-card::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 4px; background: #e2e8f0; transition: all 0.25s ease; }
        .cute-card:hover::before { width: 6px; background: #38bdf8; }

        .leaflet-popup-content-wrapper { padding: 0; border-radius: 12px; box-shadow: 0 10px 25px -5px rgba(0,0,0,0.15); overflow: hidden; }
        .leaflet-popup-content { margin: 0 !important; width: 100% !important; }
        .leaflet-popup-content p { margin: 0 !important; }
        .leaflet-container a.leaflet-popup-close-button { top: 10px; right: 10px; color: #94a3b8; font-size: 18px; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; background: transparent; border-radius: 50%; z-index: 20; }
        .leaflet-container a.leaflet-popup-close-button:hover { color: #64748b; background: #f1f5f9; }
        
        .tab-btn { transition: all 0.2s; border-radius: 99px; }
        .tab-btn.active { font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .tab-btn.boy.active { background: #dbeafe; color: #2563eb; }
        .tab-btn.girl.active { background: #ffe4e6; color: #e11d48; }

        .leaflet-control-geocoder { border-radius: 6px !important; box-shadow: 0 2px 6px rgba(0,0,0,0.1) !important; border: 2px solid #fff !important; }
        .leaflet-control-geocoder-icon { border-radius: 4px !important; width: 30px !important; height: 30px !important; }
    </style>
</head>
<body class="text-slate-600 font-sans overflow-hidden selection:bg-sky-200">

    <div id="loading-overlay" class="hidden flex">
        <div class="flex flex-col items-center">
            <i class="fa-solid fa-cloud fa-bounce text-5xl text-themeMain mb-4"></i>
            <p class="text-themeMain font-bold tracking-wider text-sm bg-white px-4 py-1 rounded-full shadow-sm">LOADING...</p>
        </div>
    </div>

    <nav class="bg-white/80 backdrop-blur-md shadow-sm border-b border-white z-50 flex-none">
        <div class="max-w-7xl mx-auto px-3 md:px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-10 md:h-16 items-center">
                <div class="flex items-center gap-1.5 md:gap-2 group">
                    <div class="bg-sky-100 p-1 md:p-2 rounded-full">
                        <i class="fa-solid fa-heart text-themeMain text-sm md:text-xl"></i>
                    </div>
                    <h1 class="text-base md:text-xl font-bold tracking-wide text-slate-700 font-cute flex items-baseline gap-2">
                        Our Love Map
                        <span class="hidden md:inline text-xs sm:text-sm font-normal text-slate-500">üìç Mapping Every Date & Memory Together</span>
                    </h1>
                </div>
                <div>
                    <button onclick="fetchData()" class="text-[11px] md:text-sm bg-slate-100 px-3 py-1 md:px-4 md:py-2 rounded-full hover:bg-sky-100 hover:text-sky-600 text-slate-500 transition shadow-sm font-bold">
                        <i class="fa-solid fa-rotate-right mr-1"></i> ÂêåÊ≠•
                    </button>
                    <a href="https://docs.google.com/spreadsheets/d/1DF-y3MZbru0_hcmwe0K0TwRW_H-s-LxhkNgKZkZiHkU/edit" target="_blank" class="ml-1 md:ml-2 text-[11px] md:text-sm bg-emerald-50 text-emerald-600 border border-emerald-100 px-3 py-1 md:px-4 md:py-2 rounded-full hover:bg-emerald-100 transition shadow-sm font-bold">
                        <i class="fa-solid fa-table mr-1"></i> Ë©¶ÁÆóË°®
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <main class="flex-1 flex flex-col md:flex-row h-full overflow-hidden p-3 md:p-6 gap-6 max-w-7xl mx-auto w-full">
        <aside class="w-full md:w-1/3 lg:w-1/4 flex flex-col h-[40%] md:h-full">
            <div class="pb-3 px-2 border-b-2 border-slate-200">
                <div class="flex justify-between items-end mb-2">
                    <div class="flex items-center gap-2">
                        <i class="fa-solid fa-images text-themeMain"></i>
                        <h2 class="font-bold text-slate-700 text-base">ÂõûÊÜ∂Áõ∏Á∞ø</h2>
                    </div>
                    <span class="text-xs bg-sky-100 text-sky-600 px-3 py-1 rounded-full font-bold" id="count-display">0</span>
                </div>
                <div class="relative">
                    <select onchange="changeSort(this.value)" class="w-full text-xs bg-slate-50 border border-slate-200 rounded-lg py-1.5 px-2 text-slate-600 focus:outline-none focus:border-themeMain cursor-pointer appearance-none font-medium">
                        <option value="date">üìÖ ‰æùÁ¥ÑÊúÉÊó•Êúü (Êñ∞ ‚Üí Ëàä)</option>
                        <option value="created">‚ú® ‰æùÊñ∞Â¢ûÈ†ÜÂ∫è (Êñ∞ ‚Üí Ëàä)</option>
                    </select>
                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-slate-500">
                        <i class="fa-solid fa-chevron-down text-[10px]"></i>
                    </div>
                </div>
            </div>
            <div id="location-list" class="flex-1 overflow-y-auto no-scrollbar pb-10 mt-2 grid grid-cols-2 gap-2 p-2 md:block md:p-0"></div>
            <button onclick="zoomToAll()" class="mt-3 w-full py-2.5 text-xs font-bold text-slate-500 hover:text-themeMain bg-white border border-slate-200 hover:border-themeMain transition shadow-sm">
                <i class="fa-solid fa-compress mr-1"></i> Ê™¢Ë¶ñÂÖ®Âúñ
            </button>
        </aside>

        <section class="w-full md:w-2/3 lg:w-3/4 p-1 relative order-1 md:order-2 h-[60%] md:h-full">
            <div id="map"></div>
            <div class="absolute bottom-6 left-1/2 -translate-x-1/2 bg-white/90 backdrop-blur px-6 py-2 rounded-full shadow-md text-xs font-bold text-slate-600 z-[400] pointer-events-none border border-sky-100 flex items-center gap-2">
                <span class="w-2 h-2 bg-themeMain rounded-full"></span>
                ‰ΩøÁî®Â∑¶‰∏äËßíÊêúÂ∞ãÊàñÈªûÊìäÂú∞ÂúñÊñ∞Â¢û
            </div>
        </section>
    </main>

    <div id="data-modal" class="fixed inset-0 bg-slate-900/40 backdrop-blur-[3px] z-[1000] hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-md overflow-hidden transform transition-all scale-100 relative">
            <button onclick="closeModal()" class="absolute top-4 right-4 w-8 h-8 flex items-center justify-center bg-slate-100 rounded-full text-slate-400 hover:bg-slate-200 transition"><i class="fa-solid fa-xmark"></i></button>
            <div class="p-8">
                <h3 class="font-bold text-2xl text-slate-700 mb-6 flex items-center gap-2">
                    <i class="fa-solid fa-pen-nib text-themeMain"></i>
                    <span id="modal-title">Write Memory</span>
                </h3>
                <form id="data-form" class="space-y-5">
                    <input type="hidden" id="entry-id"><input type="hidden" id="entry-lat"><input type="hidden" id="entry-lng">
                    <div>
                        <label class="block text-xs font-bold text-slate-400 mb-1.5 uppercase tracking-wider">Location</label>
                        <input type="text" id="entry-name" required placeholder="Âú∞ÈªûÂêçÁ®±..." class="w-full bg-slate-50 border border-slate-200 rounded-lg px-4 py-2.5 text-slate-700 focus:border-themeMain focus:bg-white outline-none transition font-medium">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-400 mb-1.5 uppercase tracking-wider">Date</label>
                        <input type="date" id="entry-date" required class="w-full bg-slate-50 border border-slate-200 rounded-lg px-4 py-2.5 text-slate-600 focus:border-themeMain focus:bg-white outline-none transition font-medium">
                    </div>
                    <div class="bg-slate-50 p-1 rounded-full flex gap-1">
                        <button type="button" onclick="switchTab('boy')" id="tab-boy" class="tab-btn boy flex-1 py-2 text-sm text-slate-400"><i class="fa-solid fa-mars mr-1"></i> Áî∑Âèã</button>
                        <button type="button" onclick="switchTab('girl')" id="tab-girl" class="tab-btn girl flex-1 py-2 text-sm text-slate-400"><i class="fa-solid fa-venus mr-1"></i> Â•≥Âèã</button>
                    </div>
                    <div id="panel-boy" class="hidden">
                        <textarea id="entry-note-boy" rows="4" placeholder="Áî∑ÂèãË™™..." class="w-full bg-blue-50/50 rounded-lg border border-blue-100 p-4 text-sm text-slate-700 outline-none focus:border-blue-300 resize-none"></textarea>
                    </div>
                    <div id="panel-girl" class="hidden">
                        <textarea id="entry-note-girl" rows="4" placeholder="Â•≥ÂèãË™™..." class="w-full bg-pink-50/50 rounded-lg border border-pink-100 p-4 text-sm text-slate-700 outline-none focus:border-pink-300 resize-none"></textarea>
                    </div>
                    <div class="pt-2 flex justify-end gap-3">
                        <button type="button" onclick="closeModal()" class="px-6 py-2.5 text-sm font-bold text-slate-400 hover:text-slate-600 transition">ÂèñÊ∂à</button>
                        <button type="submit" class="px-8 py-2.5 bg-themeMain text-white text-sm rounded-full hover:bg-sky-500 shadow-lg shadow-sky-200 transform active:scale-95 transition font-bold tracking-wide">ÂÑ≤Â≠ò</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbzIBS75lONz_PPVYoO_M72HIo0M6le_9cuiUrKYxB8w9G13D8swdXqfv4tlZ69k28OX0A/exec"; 
        
        let map;
        let markers = [];
        let spots = [];
        let currentTab = 'boy';
        let currentSort = 'date'; 

        function switchTab(gender) {
            currentTab = gender;
            const boyBtn = document.getElementById('tab-boy');
            const girlBtn = document.getElementById('tab-girl');
            const boyPanel = document.getElementById('panel-boy');
            const girlPanel = document.getElementById('panel-girl');
            if (gender === 'boy') {
                boyBtn.classList.add('active'); girlBtn.classList.remove('active');
                boyPanel.classList.remove('hidden'); girlPanel.classList.add('hidden');
            } else {
                boyBtn.classList.remove('active'); girlBtn.classList.add('active');
                boyPanel.classList.add('hidden'); girlPanel.classList.remove('hidden');
            }
        }

        function changeSort(mode) {
            currentSort = mode;
            renderAll();
        }

        function flyToSpot(lat, lng, callback) {
            const targetZoom = 16;
            const mapHeight = map.getSize().y;
            
            // Âº∑Âà∂ÈóúÈñâ (ÈÅøÂÖçÈåØ‰Ωç)
            map.closePopup();

            const point = map.project([lat, lng], targetZoom);
            const targetPoint = L.point(point.x, point.y - (mapHeight * 0.25)); 
            const newCenter = map.unproject(targetPoint, targetZoom);
            
            const currentCenter = map.getCenter();
            const dist = map.distance(currentCenter, newCenter);
            
            // Ë∑ùÈõ¢ÂæàËøëÔºåÁõ¥Êé•Èñã
            if (dist < 50) {
                if (callback) callback();
                return;
            }

            map.flyTo(newCenter, targetZoom, { animate: true, duration: 0.6 });
            
            map.once('moveend', function() {
                setTimeout(() => { if (callback) callback(); }, 150);
            });
        }

        async function fetchData() {
            showLoading(true);
            try {
                const response = await fetch(`${API_URL}?action=read&t=${new Date().getTime()}`);
                if (!response.ok) throw new Error('Network error');
                spots = await response.json();
                renderAll();
            } catch (error) {
                console.error(error);
                alert("ËÆÄÂèñÂ§±ÊïóÔºåË´ãÁ¢∫Ë™ç Script Ê¨äÈôêËàáÁ∂≤ÂùÄ„ÄÇ\n" + error.message);
            } finally {
                showLoading(false);
            }
        }

        async function sendData(action, data) {
            showLoading(true);
            try {
                const response = await fetch(`${API_URL}?action=${action}`, {
                    method: 'POST', body: JSON.stringify(data), headers: { "Content-Type": "text/plain;charset=utf-8" }
                });
                const result = await response.json();
                if (result.status === "success") { await fetchData(); closeModal(); }
                else { throw new Error(result.message); }
            } catch (error) { alert("ÂÑ≤Â≠òÂ§±ÊïóÔºö" + error.message); }
            finally { showLoading(false); }
        }

        function initMap() {
            map = L.map('map').setView([25.07, 121.51], 12);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; OpenStreetMap &copy; CARTO', maxZoom: 20
            }).addTo(map);

            L.Control.geocoder({ defaultMarkGeocode: false, placeholder: 'ÊêúÂ∞ãÂú∞Èªû...', errorMessage: 'Êâæ‰∏çÂà∞Âú∞Èªû' })
            .on('markgeocode', function(e) { flyToSpot(e.geocode.center.lat, e.geocode.center.lng); }).addTo(map);

            map.on('click', onMapClick);
            
            // Popup ÊâìÈñãÊôÇÂº∑Âà∂Ê†°Ê≠£‰ΩçÁΩÆ
            map.on('popupopen', function(e) {
                const popup = e.popup;
                setTimeout(() => { popup.update(); }, 10);
            });

            fetchData();
        }

        function getHeartIcon() {
            return L.divIcon({ className: 'heart-icon-div', html: '<i class="fa-solid fa-heart heart-marker"></i>', iconSize: [34, 34], iconAnchor: [17, 32], popupAnchor: [0, -36] });
        }

        function renderAll() {
            markers.forEach(m => map.removeLayer(m));
            markers = [];
            const listContainer = document.getElementById('location-list');
            listContainer.innerHTML = '';
            document.getElementById('count-display').innerText = spots.length;

            if (spots.length === 0) listContainer.innerHTML = `<div class="p-10 text-center text-slate-300 col-span-2">Â∞öÁÑ°ÂõûÊÜ∂</div>`;

            let sortedSpots = [...spots];
            if (currentSort === 'date') { sortedSpots.sort((a, b) => new Date(b.date) - new Date(a.date)); } 
            else if (currentSort === 'created') { sortedSpots.sort((a, b) => Number(b.id) - Number(a.id)); }

            sortedSpots.forEach(spot => {
                // UI: ÁßªÈô§‰∫Ü onclick ‰∫íÂãïÔºåÊñáÂ≠óÁõ¥Êé•È°ØÁ§∫ÂÆåÊï¥
                const popupContent = `
                    <div class="font-sans w-[280px] p-3 bg-white relative">
                        <div class="mb-2 border-b border-slate-100 pb-2 pr-24">
                            <h3 class="font-bold text-slate-800 text-base leading-tight break-words">${spot.name}</h3>
                            <div class="flex items-center gap-1 text-[11px] text-slate-400 mt-0.5">
                                <i class="fa-regular fa-calendar"></i><span>${spot.date}</span>
                            </div>
                        </div>
                        
                        <div class="absolute top-2.5 right-10 flex gap-1">
                            <a href="https://www.google.com/maps/search/?api=1&query=${spot.lat},${spot.lng}" target="_blank" class="w-6 h-6 flex items-center justify-center rounded-full bg-slate-50 text-slate-400 hover:bg-emerald-50 hover:text-emerald-500 transition" title="Google Map Â∞éËà™"><i class="fa-solid fa-location-arrow text-[10px]"></i></a>
                            <button onclick="editSpot(${spot.id})" class="w-6 h-6 flex items-center justify-center rounded-full bg-slate-50 text-slate-400 hover:bg-sky-50 hover:text-sky-500 transition" title="Á∑®ËºØ"><i class="fa-solid fa-pen text-[10px]"></i></button>
                        </div>

                        <div class="space-y-1.5 mb-2 max-h-[200px] overflow-y-auto custom-scroll pr-1">
                            <div class="flex gap-1.5 items-start">
                                <div class="w-5 h-5 rounded-full bg-blue-100 flex items-center justify-center text-blue-500 flex-none text-[10px]"><i class="fa-solid fa-mars"></i></div>
                                <div class="bg-blue-50 rounded-lg rounded-tl-none px-2 py-2 text-[13px] text-slate-600 flex-1 border border-blue-100 shadow-sm">
                                    <p class="break-words !m-0 whitespace-pre-line transition-all duration-300">${spot.note_boy || '...'}</p>
                                </div>
                            </div>
                            <div class="flex gap-1.5 items-start flex-row-reverse">
                                <div class="w-5 h-5 rounded-full bg-pink-100 flex items-center justify-center text-pink-500 flex-none text-[10px]"><i class="fa-solid fa-venus"></i></div>
                                <div class="bg-pink-50 rounded-lg rounded-tr-none px-2 py-2 text-[13px] text-slate-600 flex-1 border border-pink-100 shadow-sm text-right">
                                    <p class="break-words !m-0 text-left whitespace-pre-line transition-all duration-300">${spot.note_girl || '...'}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                // ‰øùÊåÅÁ©©ÂÆöÁâàÔºöÂêåÊ≠•È£õË°å
                const marker = L.marker([spot.lat, spot.lng], { icon: getHeartIcon() })
                    .addTo(map)
                    .bindPopup(popupContent, { maxWidth: 320, minWidth: 280, autoPan: false });
                
                marker.off('click');
                marker.on('click', function() {
                    flyToSpot(spot.lat, spot.lng, () => {
                        this.openPopup();
                    });
                });
                    
                markers.push(marker);

                const card = document.createElement('div');
                card.className = "cute-card p-3 cursor-pointer group flex flex-col justify-between h-full min-h-[110px] md:h-auto md:min-h-0";
                card.onclick = (e) => {
                    if(e.target.closest('button')) return;
                    flyToSpot(spot.lat, spot.lng, () => { marker.openPopup(); });
                };

                card.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex-1 w-full overflow-hidden">
                            <h3 class="font-bold text-slate-700 text-base group-hover:text-themeMain transition truncate">${spot.name}</h3>
                            <div class="flex items-center gap-1 text-[11px] text-slate-400 mt-1"><i class="fa-regular fa-calendar"></i><span>${spot.date}</span></div>
                        </div>
                        <div class="hidden md:flex gap-1 opacity-0 group-hover:opacity-100 transition translate-x-1 group-hover:translate-x-0">
                            <button onclick="editSpot(${spot.id})" class="text-slate-400 hover:text-sky-500"><i class="fa-solid fa-pen text-xs"></i></button>
                            <button onclick="deleteSpot(${spot.id})" class="text-slate-400 hover:text-rose-500"><i class="fa-solid fa-trash-can text-xs"></i></button>
                        </div>
                    </div>
                    <div class="space-y-1 mt-auto">
                        <div class="flex items-center gap-2 text-[11px] text-slate-400"><i class="fa-solid fa-mars text-blue-300"></i><p class="truncate flex-1">${spot.note_boy || '-'}</p></div>
                        <div class="flex items-center gap-2 text-[11px] text-slate-400"><i class="fa-solid fa-venus text-pink-300"></i><p class="truncate flex-1">${spot.note_girl || '-'}</p></div>
                    </div>
                `;
                listContainer.appendChild(card);
            });
        }

        function onMapClick(e) { openModal('add', { lat: e.latlng.lat, lng: e.latlng.lng }); }
        function openModal(mode, data = {}) {
            const modal = document.getElementById('data-modal');
            modal.classList.remove('hidden'); switchTab('boy');
            if (mode === 'add') {
                document.getElementById('modal-title').innerText = "New Memory";
                document.getElementById('data-form').reset();
                document.getElementById('entry-id').value = ''; 
                document.getElementById('entry-lat').value = data.lat;
                document.getElementById('entry-lng').value = data.lng;
                document.getElementById('entry-date').valueAsDate = new Date();
                setTimeout(() => document.getElementById('entry-name').focus(), 100);
            } else {
                document.getElementById('modal-title').innerText = "Edit Memory";
                document.getElementById('entry-id').value = data.id;
                document.getElementById('entry-name').value = data.name;
                document.getElementById('entry-date').value = data.date;
                document.getElementById('entry-lat').value = data.lat;
                document.getElementById('entry-lng').value = data.lng;
                document.getElementById('entry-note-boy').value = data.note_boy || '';
                document.getElementById('entry-note-girl').value = data.note_girl || '';
            }
        }
        function closeModal() { document.getElementById('data-modal').classList.add('hidden'); }
        window.editSpot = function(id) { const spot = spots.find(s => s.id == id); if (spot) openModal('edit', spot); };
        window.deleteSpot = function(id) { if(confirm('Á¢∫ÂÆöË¶ÅÂà™Èô§ÈÄôÁ≠ÜÂõûÊÜ∂ÂóéÔºü')) sendData('delete', { id: id }); };
        window.zoomToAll = function() {
            if (markers.length > 0) { const group = new L.featureGroup(markers); map.fitBounds(group.getBounds().pad(0.1)); }
            else { map.setView([25.07, 121.51], 12); }
        }
        function showLoading(show) { document.getElementById('loading-overlay').style.display = show ? 'flex' : 'none'; }
        document.getElementById('data-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const id = document.getElementById('entry-id').value;
            const data = {
                id: id ? id : Date.now().toString(),
                name: document.getElementById('entry-name').value, date: document.getElementById('entry-date').value,
                lat: document.getElementById('entry-lat').value, lng: document.getElementById('entry-lng').value,
                note_boy: document.getElementById('entry-note-boy').value, note_girl: document.getElementById('entry-note-girl').value
            };
            sendData(id ? 'update' : 'create', data);
        });
        window.onload = initMap;
    </script>
</body>
</html>