<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>我們的約會足跡 Map</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />

    <!-- Tailwind Config -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#f43f5e', 
                        secondary: '#fda4af', 
                        bgLight: '#f8fafc',
                    },
                    fontFamily: {
                        sans: ['"Noto Sans TC"', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <style>
        body { background-color: #f8fafc; height: 100vh; display: flex; flex-direction: column; }
        #map { height: 100%; width: 100%; z-index: 1; border-radius: 0.75rem; }
        
        .heart-icon-div { background: transparent; border: none; text-align: center; }
        .heart-marker {
            color: #f43f5e; font-size: 28px;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
            transition: transform 0.2s;
        }
        .heart-marker:hover { transform: scale(1.2); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* 載入中遮罩 */
        #loading-overlay {
            position: fixed; inset: 0; background: rgba(255,255,255,0.8);
            z-index: 2000; 
            display: flex;
            align-items: center; justify-content: center;
            backdrop-filter: blur(2px);
        }
        #loading-overlay.hidden {
            display: none;
        }
    </style>
</head>
<body class="text-slate-700 font-sans overflow-hidden">

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="hidden">
        <div class="flex flex-col items-center">
            <i class="fa-solid fa-circle-notch fa-spin text-4xl text-primary mb-3"></i>
            <p class="text-slate-600 font-medium" id="loading-text">資料同步中...</p>
        </div>
    </div>

    <!-- 導航列 -->
    <nav class="bg-white shadow-sm border-b border-slate-100 z-50 flex-none">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16 items-center">
                <div class="flex items-center gap-2">
                    <i class="fa-solid fa-heart text-primary text-2xl"></i>
                    <h1 class="text-lg sm:text-xl font-bold tracking-wide text-slate-800">我們的約會足跡</h1>
                </div>
                <div>
                    <button onclick="fetchData()" class="text-xs sm:text-sm bg-slate-100 px-3 py-1.5 rounded-lg hover:bg-slate-200 text-slate-600 transition" title="重新整理">
                        <i class="fa-solid fa-rotate-right"></i> <span class="hidden sm:inline">同步</span>
                    </button>
                    <a href="https://docs.google.com/spreadsheets/d/1DF-y3MZbru0_hcmwe0K0TwRW_H-s-LxhkNgKZkZiHkU/edit" target="_blank" class="ml-2 text-xs sm:text-sm bg-green-50 text-green-700 border border-green-200 px-3 py-1.5 rounded-lg hover:bg-green-100 transition">
                        <i class="fa-solid fa-table"></i> <span class="hidden sm:inline">試算表</span>
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <!-- 主要內容區 -->
    <main class="flex-1 flex flex-col md:flex-row h-full overflow-hidden p-2 md:p-4 gap-4 max-w-7xl mx-auto w-full">
        
        <!-- 左側：列表區 -->
        <aside class="w-full md:w-1/3 lg:w-1/4 flex flex-col bg-white rounded-xl shadow-lg border border-slate-100 overflow-hidden order-2 md:order-1 h-[40%] md:h-full">
            <div class="p-4 border-b border-slate-100 bg-slate-50 flex justify-between items-center flex-none">
                <h2 class="font-bold text-slate-700">地點列表 (<span id="count-display">0</span>)</h2>
                <button onclick="zoomToAll()" class="text-xs bg-white border border-slate-200 px-2 py-1 rounded hover:bg-slate-50 text-slate-500 transition">
                    <i class="fa-solid fa-expand"></i> 全覽
                </button>
            </div>
            
            <div id="location-list" class="flex-1 overflow-y-auto p-4 space-y-3 no-scrollbar">
                <!-- 列表將由此生成 -->
            </div>
        </aside>

        <!-- 右側：地圖區 -->
        <section class="w-full md:w-2/3 lg:w-3/4 bg-white rounded-xl shadow-lg border border-slate-100 p-1 relative order-1 md:order-2 h-[60%] md:h-full">
            <div id="map"></div>
            <div class="absolute top-4 left-1/2 -translate-x-1/2 bg-white/90 backdrop-blur px-4 py-2 rounded-full shadow-md text-xs text-slate-600 z-[400] pointer-events-none">
                <i class="fa-solid fa-hand-pointer mr-1"></i> 點擊地圖以新增
            </div>
        </section>
    </main>

    <!-- 新增/編輯 Modal -->
    <div id="data-modal" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-[1000] hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden transform transition-all scale-100">
            <div class="bg-primary p-4 text-white flex justify-between items-center">
                <h3 class="font-bold text-lg" id="modal-title">記錄新地點</h3>
                <button onclick="closeModal()" class="hover:text-slate-200"><i class="fa-solid fa-xmark"></i></button>
            </div>
            
            <form id="data-form" class="p-6 space-y-4">
                <input type="hidden" id="entry-id">
                <input type="hidden" id="entry-lat">
                <input type="hidden" id="entry-lng">
                
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">地點名稱</label>
                    <input type="text" id="entry-name" required placeholder="例如：浪漫海邊晚餐" 
                        class="w-full px-4 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent outline-none transition">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">約會日期</label>
                    <input type="date" id="entry-date" required
                        class="w-full px-4 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent outline-none transition">
                </div>

                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">備註</label>
                    <textarea id="entry-note" rows="2" placeholder="那天發生了什麼有趣的事..." 
                        class="w-full px-4 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent outline-none transition resize-none"></textarea>
                </div>

                <div class="pt-2 flex gap-3">
                    <button type="button" onclick="closeModal()" class="flex-1 px-4 py-2 border border-slate-200 text-slate-600 rounded-lg hover:bg-slate-50 transition">取消</button>
                    <button type="submit" class="flex-1 px-4 py-2 bg-primary text-white rounded-lg hover:bg-rose-600 shadow-lg shadow-rose-200 transition font-medium">儲存</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <script>
        // =========================================================
        // 【重要】請將下方的 URL 替換成您部署後的 Web App URL
        // =========================================================
        const API_URL = "https://script.google.com/macros/s/AKfycbwGXJTVVZ3ZjCl9aUnge2F27mI2OLSVo8FD_ThSqXoBkgUFDuh1vLJ2Fe_ZELJD5xvXag/exec"; 
        
        let map;
        let markers = [];
        let spots = [];

        // --- 1. API 互動邏輯 (Google Apps Script) ---

        // 讀取資料
        async function fetchData() {
            showLoading(true, "讀取雲端資料...");
            try {
                // 加一個時間戳記避免瀏覽器快取
                const response = await fetch(`${API_URL}?action=read&t=${new Date().getTime()}`);
                if (!response.ok) throw new Error('Network response was not ok');
                spots = await response.json();
                renderAll();
            } catch (error) {
                console.error("Fetch error:", error);
                alert("讀取失敗！\n原因：" + error.message + "\n\n請檢查：\n1. Google Script 部署權限是否為「所有人」？\n2. HTML 內的 API_URL 是否正確？");
            } finally {
                showLoading(false);
            }
        }

        // 寫入資料 (新增/編輯/刪除)
        async function sendData(action, data) {
            showLoading(true, "儲存至試算表...");
            
            // 由於 CORS 問題，這裡使用 text/plain 發送 JSON 字串，後端用 e.postData.contents 解析
            try {
                const response = await fetch(`${API_URL}?action=${action}`, {
                    method: 'POST',
                    body: JSON.stringify(data),
                    headers: {
                        "Content-Type": "text/plain;charset=utf-8"
                    }
                });
                
                const result = await response.json();
                if (result.status === "success") {
                    await fetchData(); // 成功後重新讀取最新資料
                    closeModal();
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                console.error("Post error:", error);
                alert("儲存失敗：\n" + error.message);
            } finally {
                showLoading(false);
            }
        }

        // --- 2. 地圖核心邏輯 ---

        function initMap() {
            map = L.map('map').setView([25.07, 121.51], 12);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap',
                maxZoom: 19
            }).addTo(map);

            map.on('click', onMapClick);
            fetchData(); // 初始化載入
        }

        function getHeartIcon() {
            return L.divIcon({
                className: 'heart-icon-div',
                html: '<i class="fa-solid fa-heart heart-marker"></i>',
                iconSize: [30, 30],
                iconAnchor: [15, 30],
                popupAnchor: [0, -35]
            });
        }

        function onMapClick(e) {
            openModal('add', { lat: e.latlng.lat, lng: e.latlng.lng });
        }

        // --- 3. 渲染與 UI ---

        function renderAll() {
            markers.forEach(m => map.removeLayer(m));
            markers = [];

            const listContainer = document.getElementById('location-list');
            listContainer.innerHTML = '';
            document.getElementById('count-display').innerText = spots.length;

            if (spots.length === 0) {
                listContainer.innerHTML = `<div class="text-center text-slate-400 py-10 text-sm">目前沒有資料，請點擊地圖新增！</div>`;
                return;
            }

            const sortedSpots = [...spots].sort((a, b) => new Date(b.date) - new Date(a.date));

            sortedSpots.forEach(spot => {
                // Map Marker
                const marker = L.marker([spot.lat, spot.lng], { icon: getHeartIcon() })
                    .addTo(map)
                    .bindPopup(`
                        <div class="text-center min-w-[150px]">
                            <h3 class="font-bold text-slate-800 text-lg mb-1">${spot.name}</h3>
                            <p class="text-xs text-slate-500 mb-2">${spot.date}</p>
                            <p class="text-sm text-slate-600 mb-3">${spot.note || ''}</p>
                            <div class="flex gap-2 justify-center">
                                <button onclick="editSpot(${spot.id})" class="text-xs bg-slate-100 px-2 py-1 rounded hover:bg-slate-200">編輯</button>
                                <a href="https://www.google.com/maps/search/?api=1&query=${spot.lat},${spot.lng}" target="_blank" 
                                   class="text-xs bg-blue-50 text-blue-600 px-2 py-1 rounded hover:bg-blue-100">導航</a>
                            </div>
                        </div>
                    `);
                markers.push(marker);

                // List Card
                const card = document.createElement('div');
                card.className = "bg-white p-3 md:p-4 rounded-lg border border-slate-100 shadow-sm hover:shadow-md transition-all cursor-pointer group hover:border-rose-200 relative";
                card.onclick = (e) => {
                    if(e.target.closest('button')) return;
                    map.setView([spot.lat, spot.lng], 15);
                    marker.openPopup();
                };

                card.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <h3 class="font-bold text-slate-800 group-hover:text-primary transition">${spot.name}</h3>
                            <div class="flex items-center gap-2 text-xs text-slate-400 mt-1">
                                <i class="fa-regular fa-calendar"></i>
                                <span>${spot.date}</span>
                            </div>
                        </div>
                        <div class="flex gap-1">
                            <button onclick="editSpot(${spot.id})" class="p-1.5 text-slate-400 hover:text-blue-500 hover:bg-blue-50 rounded transition"><i class="fa-solid fa-pen"></i></button>
                            <button onclick="deleteSpot(${spot.id})" class="p-1.5 text-slate-400 hover:text-red-500 hover:bg-red-50 rounded transition"><i class="fa-solid fa-trash-can"></i></button>
                        </div>
                    </div>
                    <p class="text-sm text-slate-600 mt-2 line-clamp-2 break-words">${spot.note || '沒有備註'}</p>
                `;
                listContainer.appendChild(card);
            });
        }

        function showLoading(show, text = "Loading...") {
            const el = document.getElementById('loading-overlay');
            const txt = document.getElementById('loading-text');
            if (show) {
                el.classList.remove('hidden');
                txt.innerText = text;
            } else {
                el.classList.add('hidden');
            }
        }

        // --- 4. 互動邏輯 ---

        function openModal(mode, data = {}) {
            const modal = document.getElementById('data-modal');
            const title = document.getElementById('modal-title');
            const form = document.getElementById('data-form');

            modal.classList.remove('hidden');

            if (mode === 'add') {
                title.innerHTML = '<i class="fa-solid fa-location-dot mr-2"></i>記錄新地點';
                form.reset();
                document.getElementById('entry-id').value = ''; 
                document.getElementById('entry-lat').value = data.lat;
                document.getElementById('entry-lng').value = data.lng;
                document.getElementById('entry-date').valueAsDate = new Date();
                setTimeout(() => document.getElementById('entry-name').focus(), 100);
            } else if (mode === 'edit') {
                title.innerHTML = '<i class="fa-solid fa-pen-to-square mr-2"></i>編輯回憶';
                document.getElementById('entry-id').value = data.id;
                document.getElementById('entry-name').value = data.name;
                document.getElementById('entry-date').value = data.date;
                document.getElementById('entry-note').value = data.note;
                document.getElementById('entry-lat').value = data.lat;
                document.getElementById('entry-lng').value = data.lng;
            }
        }

        function closeModal() {
            document.getElementById('data-modal').classList.add('hidden');
        }

        window.editSpot = function(id) {
            const spot = spots.find(s => s.id == id); // 注意 id 可能是字串或數字
            if (spot) openModal('edit', spot);
        };

        window.deleteSpot = function(id) {
            if(confirm('確定要從雲端刪除這個地點嗎？')) {
                sendData('delete', { id: id });
            }
        };

        window.zoomToAll = function() {
            if (markers.length > 0) {
                const group = new L.featureGroup(markers);
                map.fitBounds(group.getBounds().pad(0.1));
            } else {
                map.setView([25.07, 121.51], 12);
            }
        }

        // 表單提交
        document.getElementById('data-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const id = document.getElementById('entry-id').value;
            const data = {
                // 如果沒有 id 代表是新增，生成一個 timestamp 當作 ID
                id: id ? id : Date.now().toString(),
                name: document.getElementById('entry-name').value,
                date: document.getElementById('entry-date').value,
                note: document.getElementById('entry-note').value,
                lat: document.getElementById('entry-lat').value,
                lng: document.getElementById('entry-lng').value
            };

            const action = id ? 'update' : 'create';
            sendData(action, data);
        });

        window.onload = initMap;

    </script>
</body>
</html>